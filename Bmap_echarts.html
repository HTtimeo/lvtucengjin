<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bmap+echarts热力图</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            cursor: default;
        }
    </style>
</head>
<body>
<div id="container"></div>
<script src="lib/echarts.min.js"></script>
<script src='lib/kriging-original.js'></script>
<script type="text/javascript" src="lib/bmap.js"></script>
<script src="http://api.map.baidu.com/api?v=3.0&ak=s1BD4QiPJ9vgLfpzFhoq7TCbJOzi4q8t"></script>
<script src="lib/province.js"></script>
<script type="text/javascript">
    let map = null;
    let paramsK = {
        mapCenter: [114.360456, 30.538622],
        maxValue: 100,
        krigingModel: 'exponential',
        krigingSigma2: 0,
        krigingAlpha: 300,
        canvasAlpha: 0.5,
        colors: ["#006837", "#1a9850", "#66bd63", "#a6d96a", "#d9ef8b", "#ffffbf", "#fee08b", "#fdae61", "#f46d43", "#d73027", "#a50026"]
    };
    let points = [];
    let values = [];
    let top1 = 34.758;
    let bottom1 = 29.397;
    let left1 = 114.884;
    let right1 = 119.659;
    function sum(m, n) {
        return Math.random() * (m - n) + n;
    }
    let latArr = [];
    let lengArr = [];
    for (let i = 0; i < 350; i++) {
        let lat = sum(bottom1, top1);
        latArr.push(lat);
        let lat2 = sum(left1, right1);
        lengArr.push(lat2);
        values.push(sum(1, 80));
    }
    let extent = [114.884, 29.397, 119.659, 34.758];
    let maxValue = getMaxMin(values, 'max');
    let minValue = getMaxMin(values, 'min');
    let variogram = kriging.train(values, lengArr, latArr, paramsK.krigingModel, paramsK.krigingSigma2, paramsK.krigingAlpha);
    let polygons = [];
    polygons.push([[extent[0], extent[1]], [extent[0], extent[3]], [extent[2], extent[3]], [extent[2], extent[1]]]);
    let world = [];
    var positions = [];
    let anhui = province[0];
    anhui.split(";").forEach(function (v) {
        let ll = v.split(",");
        positions.push([ll[0] * 1, ll[1] * 1]);
    });
    world.push(positions);
    let grid = kriging.grid(world, variogram, (extent[2] - extent[0]) / 80);
    let myChart = echarts.init(document.getElementById("container"));
    let COLORS = ["rgba(0,0,0,0)", "#006837", "#1a9850", "#66bd63", "#a6d96a", "#d9ef8b", "#ffffbf", "#fee08b", "#fdae61", "#f46d43", "#d73027", "#a50026"];
    let lngExtent = [extent[1], extent[3]];
    let latExtent = [extent[0], extent[2]];
    let cellCount = [grid[0].length, grid.length];
    let cellSizeCoord = [(latExtent[1] - latExtent[0]) / cellCount[1], (lngExtent[1] - lngExtent[0]) / cellCount[0]];
    let data = [];
    for (let i = 0; i < grid[0].length - 1; i++) {
        for (let j = 0; j < grid.length - 1; j++) {
            if (null == grid[j][i]) {
                let d = [j, i, 0];
                data.push(d);
            } else {
                let d = [j, i, grid[j][i].toFixed(0)];
                data.push(d);
            }
        }
    }
    function renderItem(params, api) {
        let lngIndex = api.value(0);
        let latIndex = api.value(1);
        let pointLeftTop = getCoord(params, api, lngIndex, latIndex);
        let pointRightBottom = getCoord(params, api, lngIndex + 1, latIndex + 1);
        return {
            type: 'rect',
            shape: {
                x: pointLeftTop[0],
                y: pointLeftTop[1],
                width: pointRightBottom[0] - pointLeftTop[0],
                height: pointRightBottom[1] - pointLeftTop[1]
            },
            style: api.style({
                stroke: 'rgba(0,0,0,0)'
            }),
            styleEmphasis: api.styleEmphasis()
        };
    }

    function getCoord(params, api, lngIndex, latIndex) {
        var coords = params.context.coords || (params.context.coords = []);
        var key = lngIndex + '-' + latIndex;
        return coords[key] || (coords[key] = api.coord([+(latExtent[0] + lngIndex * cellSizeCoord[0]).toFixed(6), +(lngExtent[0] + latIndex * cellSizeCoord[1]).toFixed(6)]));
    }
    let option = {
        tooltip: {},
        visualMap: {
            inverse: true,
            top: 10,
            left: 10,
            min: 1,
            max: maxValue,
            inRange: {
                color: COLORS,
                opacity: 0.7
            }
        },
        bmap: {
            center: [117.283042, 31.86119],
            zoom: 8,
            roam: true
        },
        series: [
            {
                type: 'custom',
                coordinateSystem: 'bmap',
                renderItem: renderItem,
                animation: false,
                emphasis: {
                    itemStyle: {
                        color: 'yellow'
                    }
                },
                encode: {
                    tooltip: 2
                },
                data: data
            },
            {
                type: 'scatter',
                coordinateSystem: 'bmap',
                symbolSize: function (val) {
                    return val[2] / 10;
                },
                emphasis: {
                    label: {
                        show: true
                    }
                },
                label: {
                    formatter: '{b}',
                    position: 'right',
                    show: false
                },
                encode: {
                    tooltip: 2
                },
                data: [{"name": "合肥","value": [117.27,31.86,229]}]
            },
            {
                type: 'lines',
                coordinateSystem: 'bmap',
                data: world,
                polyline: true,
                lineStyle: {
                    color: 'purple',
                    opacity: 0.6,
                    width: 1
                }
            },
        ],
    };
    myChart.setOption(option);
    map = myChart.getModel().getComponent('bmap').getBMap();
    var scaleCtrl = new BMap.ScaleControl();
    map.addControl(scaleCtrl);
    function getAera() {
        new BMap.Boundary().get("安徽省", function(rs){
            for(let i=0;i<rs.boundaries.length;i++){
                let ply = new BMap.Polygon(rs.boundaries[i], {
                    strokeWeight: 2,
                    strokeOpacity:1,
                    strokeColor: "#045551"},
                );
                map.addOverlay(ply);
            }
        });
    }
    function addlabel() {
        let pointArray = [
            new BMap.Point(115.78919,33.863132),
            new BMap.Point(116.515884,31.765982),
            new BMap.Point(117.228779,31.826871),
            new BMap.Point(115.807588,32.915904),
            new BMap.Point(116.396301,32.877101)];
        let contentArray = ['亳州', '六安', '合肥', '阜阳', '阜阳2'];
        for (let i = 0; i < pointArray.length; i++) {
            let opts = {position: pointArray[i], offset: new BMap.Size(0, -0)}
            let label = new BMap.Label(contentArray[i], opts);
            label.setStyle({
                color: "rgba(43, 185, 163)",
                width: "30px",
                fontSize: "14px",
                height: "20px",
                lineHeight: "20px",
                fontFamily: "微软雅黑",
            });
            map.addOverlay(label);
        }
    }
    function getMaxMin(arr, param) {
        try {
            if (param == 'max') {
                return Math.max.apply(null, arr);
            } else if (param == 'min') {
                return Math.min.apply(null, arr);
            } else {
                return "Error:param is unsupported!";
            }
        } catch (e) {
            return "Error:" + e;
        }
    }
</script>

</body> </html>

